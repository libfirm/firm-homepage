{% extends "parts/base" %}
{%- block title -%}
	CodingConventions
{%- endblock %}
{% block content %}

<p>This document summarizes libFirm coding style conventions.
</p>
<table id="toc" class="toc"><tr><td><div id="toctitle"><h2>Contents</h2></div>
<ul>
<li class="toclevel-1 tocsection-1"><a href="#Indentation_and_formatting"><span class="tocnumber">1</span> <span class="toctext">Indentation and formatting</span></a>
<ul>
<li class="toclevel-2 tocsection-2"><a href="#Indentation"><span class="tocnumber">1.1</span> <span class="toctext">Indentation</span></a></li>
<li class="toclevel-2 tocsection-3"><a href="#C99"><span class="tocnumber">1.2</span> <span class="toctext">C99</span></a></li>
<li class="toclevel-2 tocsection-4"><a href="#Documentation"><span class="tocnumber">1.3</span> <span class="toctext">Documentation</span></a></li>
<li class="toclevel-2 tocsection-5"><a href="#Miscelaneous"><span class="tocnumber">1.4</span> <span class="toctext">Miscelaneous</span></a></li>
</ul>
</li>
<li class="toclevel-1 tocsection-6"><a href="#Tools"><span class="tocnumber">2</span> <span class="toctext">Tools</span></a>
<ul>
<li class="toclevel-2 tocsection-7"><a href="#AStyle"><span class="tocnumber">2.1</span> <span class="toctext">AStyle</span></a></li>
<li class="toclevel-2 tocsection-8"><a href="#Whitespace_Check"><span class="tocnumber">2.2</span> <span class="toctext">Whitespace Check</span></a></li>
<li class="toclevel-2 tocsection-9"><a href="#Emacs"><span class="tocnumber">2.3</span> <span class="toctext">Emacs</span></a></li>
</ul>
</li>
</ul>
</td></tr></table>
<h1><span class="mw-headline" id="Indentation_and_formatting"> Indentation and formatting </span></h1>
<p>Example:
</p>
{% code "c" %}
ir_node *maybe_create(int a, int b)
{
    ir_node *z = NULL;
    if (a + b < 10) {
        z = create_node(a, b);
    } else {
        do_something();
    }
    return z;
}
{% endcode %}
<ul><li> function and variable names are all in lowercase; words are separated with an underscore '_'
</li><li> the star from pointer declarations is put next to the name to be declared (Wrong: ir_node* foo;  Right: ir_node *foo;)
</li><li> opening curly braces for functions start on a new line
</li><li> opening curly braces for if, while, etc. start on the same line!
</li><li> in a call there is no space between the function name and the braces for the arguments
</li><li> there is a space between builtin keywords (if, while, switch, for) and the following opening braces.
</li><li> return is not a function call. So no braces around the return value
</li><li> Try to keep lines shorter than 80 characters (breaking this rule is tolerated)
</li><li> Don't break message strings between 2 lines. (so you can grep for messages in the source)
</li></ul>
<h2><span class="mw-headline" id="Indentation"> Indentation </span></h2>
<ul><li> Indentation at the beginning of the line is done with tabs.
</li><li> Indentation to match certain points in the previous line is done with spaces (see next part)
</li></ul>
<p>Indentation Example (using &lt;T&gt; to show tabs).
</p>
{% code "c" %}
void func(void)
{
<T>if (bla < 20 && foobar_bar(long_variable_name) || another_long_thingy
<T>    && this_was_a_long_condition) {
<T><T>print();
<T><T>foobar(a, b, more_long_stuff_here,
<T><T>       and_this_is + another * (longish - argument);
<T>}
}
{% endcode %}
<p>This style allows different people to set tab to different sizes and still get nice layout. Most firm developers tend to set tab to 4 spaces though.
</p>
<ul><li> Case labels should not get extra indentation. Correct example:
</li></ul>
{% code "c" %}
switch (foo) {
case BLA_ENUM_VAL:
    FooBar();
    break;
default:
    break;
}
{% endcode %}
<h2><span class="mw-headline" id="C99"> C99 </span></h2>
<p>We would like to use C99. Unfortunately MSVC doesn't support this standard till today. So you should consider:
</p>
<ul><li> Declarations are only allowed at the beginning of {} blocks!
</li><li> stdint.h and stdbool.h from C99 are allowed inside .c files (because we can supply our own replacements for msvc) but mustn't be used in the public API
</li><li> long long is fine as it is understood from newer msvc versions, but constants like 42LL don't appear to work (FYI long double is ANSI-C anyway)
</li><li> arrays without length at the end of structs are okay
</li></ul>
<h2><span class="mw-headline" id="Documentation"> Documentation </span></h2>
<ul><li> All functions in the public API (= stuff in the headers in libfirm/include) must have at least a short doxygen documentation
</li><li> Documentation for functions should be put in the header (except of course static functions which are only in the C file)
</li><li> Each file must have an @brief doxygen comment describing the intention/purpose of the file (except public headers with a detailed description in a @defgroup)
</li><li> Each file must have an @author doxygen comment so that we can easily see who has written what code.
</li></ul>
<h2><span class="mw-headline" id="Miscelaneous"> Miscelaneous </span></h2>
<ul><li> Every .c file must start with #include &lt;config.h&gt; (after the license,doxygen comments). This is needed make autoconf/configure work correctly.
</li></ul>
<h1><span class="mw-headline" id="Tools"> Tools </span></h1>
<h3><span class="mw-headline" id="AStyle"> AStyle </span></h3>
<p>You can use astyle to enforce some of the rules above with the following options (needs astyle 1.24):
</p>
<pre>indent=tab=4
brackets=stroustrup
indent-cases
indent-col1-comments
pad-header
keep-one-line-statements
align-pointer=name
</pre>
<h3><span class="mw-headline" id="Whitespace_Check"> Whitespace Check </span></h3>
<p>A simple python script to check at least the tab/whitespace rules:
</p>
{% code "python" %}
#!/usr/bin/env python
import sys
import re

file_list = sys.argv[1:]

for filename in file_list:
    file = open(filename, "r")
    num  = 1
    lastline = None
    for line in file.readlines():
        # Tab characters are only allowed as very first characters on a line!
        if re.search("[^\t]\t", line):
            print "%s:%d:  tabulator not at beginning of line" % (filename, num)
        if re.search(" +$", line):
            print "%s:%d:  trailing whitespace" % (filename, num)
        num += 1
        lastline = line
    if lastline != None and lastline[-1:] != '\n':
        print "%s:%d: No newline at end of file" % (filename, num)
{% endcode %}
<h3><span class="mw-headline" id="Emacs"> Emacs </span></h3>
<p>The following style spec appears to make Emacs obey the coding conventions:
</p>
{% code "common-lisp" %}
(c-add-style "firm"
            '("stroustrup"
              (case-label . 0)
              (statement-case-intro . +)
              (statement-case-open . +)
              (indent-tabs-mode . t)
              (c-basic-offset   . 4)
              (tab-width . 4)) nil)
{% endcode %}

{% endblock %}
